---
title: 蓝牙配网(Blufi)
---

# 蓝牙配网协议规范

## 1. 协议概述

### 1.1 协议定义

本协议定义了基于蓝牙低功耗（BLE）技术的设备WiFi配网通信规范，采用GATT（Generic Attribute Profile）服务架构，实现移动设备与IoT设备之间的配网数据交换。

### 1.2 协议特性

- **传输层**: 蓝牙低功耗（BLE 4.0+）
- **应用层**: 自定义二进制协议
- **数据编码**: UTF-8字符串 + 二进制数据
- **最大传输单元**: 247字节（受BLE MTU限制）
- **序列控制**: 8位序列号（0-255循环）

## 2. 服务架构

### 2.1 GATT服务定义

**主服务UUID**: `0000FFFF-0000-1000-8000-00805F9B34FB`

**特征值定义**:

| 特征值名称 | UUID | 属性 | 描述 |
|-----------|------|------|------|
| 发送特征值 | `0000FF01-0000-1000-8000-00805F9B34FB` | Write | 客户端向设备发送数据 |
| 接收特征值 | `0000FF02-0000-1000-8000-00805F9B34FB` | Notify | 设备向客户端推送数据 |

### 2.2 设备识别

**设备名称规则**: 设备名称必须匹配正则表达式 `/^(DTXZ|BLUFI_DEVICE|ESP_)/i`

**连接模式**:

- 设备作为外围设备（Peripheral）进行广播
- 移动端作为中心设备（Central）发起连接

## 3. 数据帧格式

### 3.1 帧结构定义

```
+--------+--------+--------+--------+--------+...+--------+
| Type   |FrameCtrl| SeqNum | Length |      Payload     |
+--------+--------+--------+--------+--------+...+--------+
| 1 byte | 1 byte | 1 byte | 1 byte |    0-243 bytes   |
```

### 3.2 字段说明

#### Type字段（1字节）

帧类型标识，定义数据包的功能类型：

| 值 | 名称 | 方向 | 描述 |
|----|------|------|------|
| 0x01 | WIFI_SCAN_REQ | 客户端→设备 | WiFi扫描请求 |
| 0x02 | WIFI_SCAN_RSP | 设备→客户端 | WiFi扫描结果 |
| 0x09 | SSID_DATA | 客户端→设备 | SSID数据传输 |
| 0x0D | PASSWORD_DATA | 客户端→设备 | 密码数据传输 |
| 0x0C | CONNECT_CMD | 客户端→设备 | 连接WiFi命令 |
| 0x3D | STATUS_REPORT | 设备→客户端 | 连接状态报告 |

#### FrameCtrl字段（1字节）

帧控制位，各位定义如下：

| 位 | 名称 | 描述 |
|----|------|------|
| 0 | 加密标志 | 0=未加密，1=已加密 |
| 1 | 校验标志 | 0=无校验，1=有校验 |
| 2 | 方向标志 | 0=客户端到设备，1=设备到客户端 |
| 3 | ACK标志 | 0=无需ACK，1=需要ACK |
| 4 | 分片标志 | 0=完整帧，1=分片帧 |
| 5-7 | 保留位 | 必须为0 |

#### SeqNum字段（1字节）

序列号，用于数据包排序和重传控制：

- 取值范围：0-255
- 循环使用，到达255后回到0
- 每发送一个数据包，序列号递增1

#### Length字段（1字节）

Payload数据长度，取值范围0-243字节

#### Payload字段（0-243字节）

实际数据内容，根据帧类型不同而变化

## 4. 协议流程

### 4.1 连接建立

1. **设备发现**
   - 客户端启动BLE扫描
   - 过滤符合命名规则的设备
   - 选择目标设备

2. **BLE连接**
   - 建立GATT连接
   - 发现服务和特征值
   - 启用通知特征值

3. **协议初始化**
   - 重置序列号为0
   - 建立数据监听

### 4.2 WiFi扫描流程

#### 4.2.1 扫描请求

**帧格式**:

```
Type: 0x01
FrameCtrl: 0x00
SeqNum: <当前序列号>
Length: 0x00
Payload: (空)
```

#### 4.2.2 扫描响应

**帧格式**:

```
Type: 0x02
FrameCtrl: 0x04 (设备到客户端)
SeqNum: <对应序列号>
Length: <数据长度>
Payload: <WiFi列表数据>
```

**Payload数据格式**:

```
+--------+--------+--------+...+--------+
| Length | RSSI   |    SSID Bytes    |
+--------+--------+--------+...+--------+
| 1 byte | 1 byte |   Length-1 bytes |
```

多个WiFi网络按此格式连续排列。

**RSSI转换规则**:

- 原始RSSI为有符号字节（-128到127）
- 如果RSSI > 127，则实际值 = RSSI - 256
- 信号强度 = (RSSI + 100)，映射到0-100范围

### 4.3 WiFi配置流程

#### 4.3.1 SSID配置

**帧格式**:

```
Type: 0x09
FrameCtrl: 0x00
SeqNum: <当前序列号>
Length: <SSID字节长度>
Payload: <SSID的UTF-8字节>
```

#### 4.3.2 密码配置

**帧格式**:

```
Type: 0x0D
FrameCtrl: 0x00
SeqNum: <当前序列号>
Length: <密码字节长度>
Payload: <密码的UTF-8字节>
```

#### 4.3.3 连接命令

**帧格式**:

```
Type: 0x0C
FrameCtrl: 0x00
SeqNum: <当前序列号>
Length: 0x00
Payload: (空)
```

### 4.4 状态监控

#### 4.4.1 状态报告

**帧格式**:

```
Type: 0x3D
FrameCtrl: 0x04 (设备到客户端)
SeqNum: <序列号>
Length: <状态数据长度>
Payload: <状态数据>
```

**状态数据格式**:

```
+--------+--------+
| OpMode | Status |
+--------+--------+
| 1 byte | 1 byte |
```

**OpMode定义**:

- 0x01: Station模式
- 0x02: AP模式
- 0x03: Station+AP模式

**Status定义**:

- 0x00: 连接成功
- 0x01: 连接失败
- 0x02: 密码错误
- 0x03: 网络不存在
- 0x04: 连接超时

## 5. 字符编码规范

### 5.1 UTF-8编码

所有字符串数据必须使用UTF-8编码：

**编码规则**:

- ASCII字符（0x00-0x7F）：直接编码
- 双字节字符（0x80-0x7FF）：110xxxxx 10xxxxxx
- 三字节字符（0x800-0xFFFF）：1110xxxx 10xxxxxx 10xxxxxx
- 四字节字符（0x10000-0x10FFFF）：11110xxx 10xxxxxx 10xxxxxx 10xxxxxx

### 5.2 字符串转换

**编码过程**:

1. 获取字符的Unicode码点
2. 根据码点范围选择编码方式
3. 生成对应的字节序列

**解码过程**:

1. 读取字节序列
2. 根据首字节判断字符长度
3. 组合字节生成Unicode码点
4. 转换为字符

## 6. 错误处理

### 6.1 连接错误

**错误类型**:

- 设备未找到
- 连接超时
- 服务不可用
- 特征值不支持

**处理策略**:

- 自动重试连接（最多3次）
- 重置蓝牙适配器
- 提示用户检查设备状态

### 6.2 数据传输错误

**错误类型**:

- 写入失败
- 数据丢失
- 序列号错误
- 超时无响应

**处理策略**:

- 检测连接状态
- 重新发送数据
- 重置序列号
- 断开并重连

### 6.3 配网错误

**错误类型**:

- WiFi密码错误
- 网络不存在
- 连接超时
- 设备忙碌

**错误判断**:

- 根据状态报告中的Status字段判断
- 根据配网进度停滞情况判断
- 根据超时时间判断

## 7. 安全考虑

### 7.1 数据保护

- WiFi密码等敏感数据在传输过程中应考虑加密
- 序列号机制防止重放攻击
- 连接状态监控防止中间人攻击

### 7.2 访问控制

- 设备名称验证确保连接正确设备
- GATT服务UUID验证确保协议兼容性
- 连接超时机制防止资源占用

## 8. 性能优化

### 8.1 传输优化

- 使用最大MTU（247字节）提高传输效率
- WiFi列表去重减少数据量
- 合理的超时设置平衡响应性和可靠性

### 8.2 连接优化

- 复用现有连接避免频繁建立/断开
- 连接状态监控及时发现异常
- 自动重连机制提高可用性

## 9. 兼容性

### 9.1 平台兼容性

- 支持iOS 9.0+和Android 5.0+
- 统一的API接口适配不同平台差异
- 标准BLE协议确保设备兼容性

### 9.2 设备兼容性

- 支持ESP32系列芯片
- 兼容标准BluFi协议
- 向后兼容旧版本设备

---

**协议版本**: 1.0  
**最后更新**: 2024年
